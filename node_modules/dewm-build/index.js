var fs = require('fs');
var xml2js = require('xml2js');
var utils = require('dewm-utils');
var paths = require('dewm-paths');
var templates = require('dewm-templates');
var transformations = require('dewm-transformations'); 
var build = {xml:{},html:{},gallery:{},touts:{},elements:{},image:{},menu:{cartoon:{},toc:{}}};

// "week" is the index of the week in the dewm.weeks object and "i" is the index of the stack in that week. This is the first function that runs when a transformation is set to begin. It then calls a bunch of secondary functions, which eventually return an HTML string that is written to the final output HTML file in this function.
build.init = function(w,i,type,dewm,callback) {
	var week = dewm.weeks[w],
		stack = week.files[i],
		date = dewm.dates.strings[w],
		xmlfile = build.xml.path(week,week.condenet,date,week.stacks[i]),
		output = type=="danville" ? week.orange+"Digital Danville/" : "/Volumes/Macintosh HD/Users/nilkanthpatel/Desktop/test/",
		//output = type=="danville" ? week.orange+"Digital Danville/" : week.green,
		html, htmlfile, transform;
	fs.readFile(xmlfile, "utf8", function (err, xml) {
		// Create a folder for the stack in the right directory and then create the HTML file
		htmlfile = build.html.path(output,stack);
		fs.exists(output+stack, function (exists) {
			if (!exists) { fs.mkdir(output+stack,function(err,data){ build.xml.transform(stack,xml,type,output,htmlfile,callback); });} 
			else { build.xml.transform(stack,xml,type,output,htmlfile,callback); };
		});
	});
};

// Function to figure out what the HTML file path should be.
build.html.path = function(output,stack) {
	return output+stack+"/"+stack+".html";
};

// Function to figure out what the xml file path should be, taking into account exceptions like the Talk and GOAT menus.
build.xml.path = function(week,output,date,stack) {
	if (stack.stack.indexOf("0100")+stack.stack.indexOf("7000") > -2) { var filename = date+"gofr_GOAT_front.xml"; }
	else { var filename = stack.xmlfilename+".xml"; };
	return output+filename;
};

// Function to figure out which transformation script to run, running it, and then writing the HTML to the right file.
build.xml.transform = function(stack,xml,type,output,htmlfile,callback) {
	if 		(stack.indexOf("0100_") == 0) { var transform = build.menu.toc.init; }
	else if (stack.indexOf("1400_") == 0) { var transform = build.menu.talk; }
	else if (stack.indexOf("0400_") == 0) { var transform = build.menu.goat; }
	else if (stack.indexOf("7000_") == 0) { var transform = build.menu.cartoon.init; }
	else { var transform = build.default; };
	transform(xml,output,function(html,xml,response) {
		if (type=="danville") { html = html.replace("<!--insert danville script here-->",templates.danville.scripts).replace("<!--insert caption here-->",templates.danville.caption.replace("<!--insert caption here-->",xml.caption).replace("<!--insert credit here-->",xml.credit)); };
		if (response.status) { fs.writeFile(htmlfile, html); }
		if (callback) { callback(response); }
		console.log(response.text);
	});
};

build.xml.pre = function(xml) {
	// Escape certain fields in the XML that would be parsed incorrectly by xml2js.
	xml=build.xml.escape(xml,["share_email","elementcaption","tout_1","tout_2","tout_3","tout_4","tout_5"]);
	return xml;
};

build.xml.escape = function(xml,tags) {
	for (var j=0; j<tags.length; j++) {
		var tag=tags[j], temp = xml.split("<"+tag+">");
		if (temp.length>1) {
			for (var i=1; i<temp.length; i++) {
				var caption = [ escape(temp[i].split("</"+tag+">")[0]),temp[i].split("</"+tag+">")[1] ];
				temp[i]=caption.join("</"+tag+">");
			};
			xml=temp.join("<"+tag+">");
		};
	};
	return xml;
};

build.xml.post = function(xml,content,output) {
	xml=xml.document,
	xml.content=content;
	xml.output=output;
	xml.shareurls.share_email=unescape(xml.shareurls.share_email);
	if (xml.image) { 
		if (xml.imagetype) { xml.gallerycredit = xml.imagetype+" by "+xml.credit; }
		else { xml.gallerycredit = xml.credit; };
	};
	if (xml.stackname.indexOf("talk") > -1 || xml.stackname.indexOf("comm") > -1) {
		if (!xml.image) { xml.image = xml.spot; }
		else if (xml.stackname.indexOf("_surowiecki_")>-1) { xml.credit=""; }
		xml.image=xml.image.replace("rgb","").replace("_rd",""); }
	else if (xml.stackname.indexOf("crit") == 0) { xml.subhead = '<span class="grey">The Critics&nbsp;</span>&nbsp;'+xml.subhead; }
	else if (xml.title == "The Mail") { xml.stackname = "0300_mail_"+xml.filename.split("mama_mail")[0]; };
	return xml;
};

build.default = function(xml,output,callback) {
	var content=xml.split("<content>")[1].split("</content>")[0]
		xml=build.xml.pre(xml);
	xml2js.parseString(xml, {explicitArray: false}, function (err, result) {
		if (err) { console.log("The XML for the stack is malformed.")}
		else {
			xml=build.xml.post(result,content,output);
			build.image.art(xml);
			transformations.router(xml.stackname)(xml,function(html,response) {callback(html,xml,response);});
		};
	});
};

build.gallery.init = function(w,i,type,dewm,callback) {
	var week = dewm.weeks[w],
		stack = week.files[i],
		date = dewm.dates.strings[w],
		xmlfile = build.xml.path(week,week.condenet,date,week.stacks[i]),
		output = type=="danville" ? week.orange+"Digital Danville/HTMLResources/media/" : "/Volumes/Macintosh HD/Users/nilkanthpatel/Desktop/test/HTMLResources/media/",
		//output = type=="danville" ? week.orange+"Digital Danville/HTMLResources/media/" : week.green+"HTMLResources/media/",
		htmlfile, jsfile;
	fs.readFile(xmlfile, "utf8", function (err, xml) {
		// Create a folder for the stack in the right directory and then create the HTML file
		htmlfile = output+utils.format.stack.trim(stack)+"/"+utils.format.stack.trim(stack)+"_gallery.html";
		jsfile = output+utils.format.stack.trim(stack)+"/gallery-data.js";
		fs.exists(output+utils.format.stack.trim(stack), function (exists) {
			if (!exists) { fs.mkdir(output+utils.format.stack.trim(stack),function(err,data){ build.gallery.transform(stack,xml,type,output,htmlfile,jsfile,callback); });} 
			else { build.gallery.transform(stack,xml,type,output,htmlfile,jsfile,callback); };
		});
	});
};

build.gallery.transform = function(stack,xml,type,output,htmlfile,jsfile,callback) {
	var html = templates.gallery.body,
		content=xml.split("<content>")[1].split("</content>")[0],
		xml=build.xml.pre(xml);
	xml2js.parseString(xml, {explicitArray: false}, function (err, result) {
		if (err) { console.log("The XML for the "+xml.stackname+" stack is malformed.")}
		else {
			xml=build.xml.post(result,content,output);
			transformations.gallery.router(xml.stackname)(xml,function(js,images,response) {
				if (response.status) { build.gallery.images(images,xml); fs.writeFile(htmlfile, html); fs.writeFile(jsfile, js); }
				if (callback) { callback(response); }
				console.log(response.text);
			});
		};
	});
};

build.gallery.images = function(images,xml) {
	var date = utils.format.date.stack(xml.stackname), trimmed=utils.format.stack.trim(xml.stackname);
	for (var i=0; i<images.length; i++) { 
		build.image.copy({from:build.image.path("",2560,images[i].file+".jpg", date), type:"gallery", to:xml.output+"HTMLResources/media/"+trimmed+"/", filename:images[i].file+".jpg"});
	};
};

build.menu.talk = function(xml,output,callback) {
	var content=xml.split("<content>")[1].split("</content>")[0],
		xml=build.xml.pre(xml);
	xml2js.parseString(xml, {explicitArray: false}, function (err, result) {
		var xml = build.xml.post(result,content,output), talk="", html="", week = dewm.dates.strings.indexOf(utils.format.date.stack(xml.stackname)), stacks = dewm.weeks[week].files,
			response = {status:true,text:"Successfully built 1400_talk_menu stack."};
		for (var i=0; i<stacks.length; i++) {
			if (stacks[i].indexOf("_talk_")>-1 && stacks[i].indexOf("_talk_menu_")==-1 ) { talk+=transformations.talkmenu(dewm.weeks[week].stacks[i],templates.talk.opener.single); };
		};
		xml.content = transformations.cleanup(xml).split(" ",25).join(" ").replace(' class="descender"',"")+"...</p>";
		html = transformations.header(xml,templates.talk.opener.body).replace("<!--insert blurb here-->",xml.content).replace("<!--insert talk here-->",talk);
		callback(html,xml,response);
	});
};

build.menu.toc.init = function(xml,output,callback) {
	var response = {status:true,text:"Successfully built 0100_toc stack."};
		content=xml.split("<content>")[1].split("</content>")[0], xml=build.xml.pre(xml);
	xml2js.parseString(xml, {explicitArray: false}, function (err, xml) {
		var date = utils.format.date.stack(xml.document.stackname), week = dewm.dates.strings.indexOf(date), 
			toc = {dept:"",crit:"",fiction:"",talk:"",cover:"", date:dewm.dates.dates[week], dateString:date, dateFormatted:dewm.dates.stringsFormatted[week], volume:parseInt(xml.document.volumenumber), issue:parseInt(xml.document.issuenumber)}, 
			candidates = build.menu.toc.candidates(dewm.weeks[week].files,week), html = templates.stacks.cartoon;
		build.menu.toc.build(candidates,0,toc,function(toc) {
			html = transformations.toc.body(toc);
			build.image.copy({from:paths.images.toc, type:"thumbnail", to:output+"0100_toc_"+date+"/", filename:"toc.png"})
			callback(html,xml,response);
		});
	});
};

build.menu.toc.candidates = function(stacks,week) {
	var candidates=[];
	for (var i=0; i<stacks.length; i++) {
		if (stacks[i].indexOf("_goat_")==-1) {
			var stack=dewm.weeks[week].stacks[i];
			stack.xmlfilename=build.xml.path(dewm.weeks[week],dewm.weeks[week].condenet,dewm.dates.strings[week],dewm.weeks[week].stacks[i]);
			candidates.push(stack); 
		};
	}; return candidates;
};

build.menu.toc.check = function(stack,toc,callback) {
	var xmlfilename=stack.xmlfilename;
	fs.readFile(xmlfilename, "utf8", function (err, xml) {
		if (xml!==undefined) {
			xml=build.xml.pre(xml);
			xml2js.parseString(xml, {explicitArray: false}, function (err, xml) {
				xml=xml.document;
				var route = transformations.toc.router(stack.stack);
					toc = route.func(xml,toc,route.template,route.prop);
				callback(toc);
			}); }
		else if (xmlfilename.indexOf("_cover")>-1) { toc=transformations.toc.cover(stack,toc); callback(toc); }
		else { callback(toc); }
	});
};

build.menu.toc.build = function(stacks,i,toc,callback) {
	if (i<stacks.length) {
		build.menu.toc.check(stacks[i],toc,function(toc) { build.menu.toc.build(stacks,i+1,toc,callback); }); 
	} else { callback(toc) };
};

// Note that all of these transform functions can be found in stacks.js
var transformTOCToHTML = function(condeNetXMLStr,stackName,rootDirectory,callback) {

					if (tocDeptCount == 3) {
						tocDepts = tocDepts+"\r<hr>\r"+currentToc;
					} else {
						tocDepts = tocDepts+"\r"+currentToc;
					}

			
}

build.menu.cartoon.init = function(xml,output,callback) {
	var content=xml.split("<content>")[1].split("</content>")[0],
		xml=build.xml.pre(xml), html=templates.stacks.cartoon;
	xml2js.parseString(xml, {explicitArray: false}, function (err, xml) {
		var date = utils.format.date.stack(xml.document.stackname), week = dewm.dates.strings.indexOf(date), stacks = dewm.weeks[week].files,
			response = {status:true,text:"Successfully built 7000_cart_cartoons stack."}, candidates = build.menu.cartoon.candidates(stacks,week);
		build.menu.cartoon.first(candidates,0,function(cartoon) {
			if (cartoon) { var html = transformations.cartoon.stack(cartoon,date) };
			callback(html,xml,response);
		});
	});
};

build.menu.cartoon.candidates = function(stacks,week) {
	var candidates=[];
	for (var i=0; i<stacks.length; i++) {
		var check = stacks[i].indexOf("_comm_")+stacks[i].indexOf("_talk_")+stacks[i].indexOf("_dept_")+stacks[i].indexOf("_crit_");
		if (check>-4) { 
			var stack=dewm.weeks[week].stacks[i];
			stack.xmlfilename=build.xml.path(dewm.weeks[week],dewm.weeks[week].condenet,dewm.dates.strings[week],dewm.weeks[week].stacks[i]);
			candidates.push(stack); 
		};
	}; return candidates;
};

build.menu.cartoon.check = function(xmlfilename,callback) {
	var result=[];
	fs.readFile(xmlfilename, "utf8", function (err, xml) {
		if (xml!==undefined) {
			xml=build.xml.pre(xml);
			xml2js.parseString(xml, function (err, xml) {
				if (xml.document.articleelements[0].element) {
					var elements = xml.document.articleelements[0].element;
					for (var i=0; i<elements.length; i++) { if (elements[i].type=="element_cartoon") { result.push(elements[i]) }; };
					callback(result)
				} else { callback(result); }
			});
		} else { callback(result); }
	});
};

build.menu.cartoon.first = function(stacks,i,callback) {
	if (i<stacks.length) {
		build.menu.cartoon.check(stacks[i].xmlfilename,function(result) { 
			if (result.length>0) { callback(result[0]); }
			else { build.menu.cartoon.first(stacks,i+1,callback); }
		});
	} else { callback(null) };
};

build.menu.cartoon.all = function(stacks,i,all,callback) {
	if (i<stacks.length) {
		build.menu.cartoon.check(stacks[i].xmlfilename,function(result) { 
			all.concat(result);
			build.menu.cartoon.all(stacks,i+1,all,callback);
		});
	} else { callback(all) };
};

build.menu.goat = function(xml,output,callback) {
	var content=xml.split("<content>")[1].split("</content>")[0],
		xml=build.xml.pre(xml);
	xml2js.parseString(xml, {explicitArray: false}, function (err, result) {
		var xml = build.xml.post(result,content,output), talk="", html="", week = dewm.dates.strings.indexOf(utils.format.date.stack(xml.stackname)), stacks = dewm.weeks[week].files,
			response = {status:true,text:"Successfully built 1400_talk_menu stack."};
		for (var i=0; i<stacks.length; i++) {
			if (stacks[i].indexOf("_talk_")>-1 && stacks[i].indexOf("_talk_menu_")==-1 ) { talk+=transformations.talkmenu(dewm.weeks[week].stacks[i],templates.talk.opener.single); };
		};
		xml.content = transformations.cleanup(xml).split(" ",25).join(" ").replace(' class="descender"',"")+"...</p>";
		html = transformations.header(xml,templates.talk.opener.body).replace("<!--insert blurb here-->",xml.content).replace("<!--insert talk here-->",talk);
		callback(html,xml,response);
	});
};

// This function takes the content within the tabletmultimediaextras XML tag of the CondeNet XML (input as a string) and outputs a string formatted as a Javascript object that can then be inserted directly into the HTML
build.touts.init = function(xml) {
	var touts=xml.tabletmultimediaextras, stack=xml.stackname, html = "";
	for (var i=1; i<6; i++) {
		var tout = build.touts.format(touts["tabletextra_"+i],i,stack);
		if (tout.type) { 
			html+=templates.tout
			.replace(/<!--insert type here-->/g,tout.type)
			.replace(/<!--insert text here-->/g,unescape(tout.text))
			.replace(/<!--insert id here-->/g,tout.id)
			.replace(/<!--insert src here-->/g,tout.src);
		};
	};
	return html;
};

build.touts.format = function(tout,i,stack) {
	var date=utils.format.date.stack(stack);
	tout.type = tout["type_"+i].toLowerCase().replace(" ",""), tout.text = tout["tout_"+i], tout.src = tout["ref_"+i], tout.id="", tout.i = i;
	if (tout.type=="video") { if (tout.src.indexOf(date)==-1) { tout.id=tout.src, tout.src="";  } }
	else if (tout.type=="audio") { tout.src="http://downloads.newyorker.com/mp3/"+tout.src+".mp3" }
	else if (tout.type=="slideshow") { tout.src="../HTMLResources/media/"+stack+"/"+stack+"_slideshow.html" };
	return tout;
};

build.elements.init = function(xml) {
	var elements = xml.articleelements.element,
		elementsArray=[];
	if (elements) {
		if (elements.length===undefined) { elements=[elements]; }
		for (i in elements) {
			var element=elements[i], type=element.type.split("_")[1];
			elementsArray.push(build.elements[type](element,xml))
		};
	};
	return elementsArray;
};

build.elements.cartoon = function(element,xml) {
	var date = utils.format.date.stack(xml.stackname), stack = xml.stackname;
	build.image.cartoon(date,element.imagename,xml.output);
	// Check if it's an archive toon
	if (element.imagename[0] === "a" && !isNaN(element.imagename[1])) { var html=templates.elements.cartoon.regular; } 
	else { var html=templates.elements.cartoon.archive.replace(/<!--insert archive toon date here-->/g, utils.format.date.archive(element.imagename));; };
	return html
		.replace(/<!--insert a number here-->/g, element.imagename)
		.replace(/<!--insert date here-->/g, date)
		.replace(/<!--insert caption here-->/g, unescape(element.elementcaption));
};

build.elements.spot = function(element,xml) {
	var date = utils.format.date.stack(xml.stackname), stack = xml.stackname;
	build.image.spot(xml,element.imagename,xml.output);
	return templates.elements.spot
		.replace(/<!--insert r number here-->/g, element.imagename)
		.replace(/<!--insert date here-->/g, date)
		.replace(/<!--insert trimmed stackname here-->/g, utils.format.stack.trim(stack));
};

build.elements.art = function(element,xml) {
	var date = utils.format.date.stack(xml.stackname), stack = xml.stackname;
	return templates.elements.art
		.replace(/<!--insert r number here-->/g, element.imagename)
		.replace(/<!--insert date here-->/g, date)
		.replace(/<!--insert stackname here-->/g, stack)
		.replace(/<!--insert caption here-->/g, unescape(element.elementcaption));
};

build.elements.newsbreak = function(element,xml) {
	var date = utils.format.date.stack(xml.stackname), stack = xml.stackname;
	var newsbreakFile = window.condenetDirectory.resolvePath(imagename+".xml");
	var fileStream = new air.FileStream();
	fileStream.open(newsbreakFile, air.FileMode.READ);
	var newsbreakXMLStr = fileStream.readMultiByte(newsbreakFile.size, air.File.systemCharset);
	fileStream.close();
	var newsbreakTitle = newsbreakXMLStr.split("<title>")[1].split("</title>")[0];
	var newsbreakText = newsbreakXMLStr.split("<content>")[1].split("</content>")[0].replace(new RegExp("paragraph>", 'g'), "p>");
	var newsbreakSub = newsbreakXMLStr.split("<summary>")[1].split("</summary>")[0];
	var currentElementHTML = window.newsbreakTemplate.replace("<!--insert newsbreak title here-->",newsbreakTitle).replace("<!--insert newsbreak text here-->",newsbreakText).replace("<!--insert newsbreak sub here-->",newsbreakSub);
	return templates.elements.newsbreak;
};

// Sprinkle elements into the HTML
build.elements.insert = function(content,elements) {
	if (elements[elements.length-1].indexOf('class="newsbreak"')>-1) {content+="\n\t\t"+elements[elements.length-1]; elements.splice(-1,1);};
	var count = elements.length,
		spacing = content.length/(count+1);
	for (var i=1; i<=elements.length; i++) {
		var html = "\r\r\t\t"+elements[i-1].replace(/\n/g,"\r").replace(/\t\t/g,"\t\t\t\t")+"\r",
			slice = content.slice((i-1)*spacing,i*spacing),
			paragraphs = content.match(/<\/p>/g);
		if (paragraphs.length == 0) { var index=i*spacing; }
		else { var index=(i-1)*spacing+slice.lastIndexOf("</p>"); }
		content=content.splice(index+4,0,html);
	};
	return content;
 };

build.toolbox = function(xml,touts) {
	// Construct the piece's toolbox, beginning with the Share URLs
	if (xml.stackname.indexOf("_shouts_")>-1) { touts=touts+'\n\t\t\t{"type":"weblink", "text":"Daily Shouts: New humor, five days a week.", "src":"http://www.newyorker.com/humor/daily-shouts"},\n\t\t\t{"type":"weblink", "text":"The Borowitz Report: The news, reshuffled.", "src":"http://www.newyorker.com/humor/borowitz-report"}' }
	else if (xml.stackname.indexOf("_comm_")>-1) { touts=touts+'{"type":"weblink", "text":"Daily Comment: Opinions, arguments, and reflections on the news.", "src":"http://www.newyorker.com/news/daily-comment"}'; }
	return templates.toolbox
		.replace("<!--insert facebook here-->",xml.shareurls.share_facebook)
		.replace("<!--insert twitter here-->",xml.shareurls.share_twitter)
		.replace("<!--insert email here-->",xml.shareurls.share_email)
		.replace("<!--insert bitly here-->",xml.shareurls.share_bitly)
		.replace("<!--insert touts here-->",touts);
};

var transformGoatContent = function(theCondeNetXMLText,stackName) {
	var danvilleHTML = theCondeNetXMLText.slice(theCondeNetXMLText.indexOf("<content>")+10,theCondeNetXMLText.indexOf("</content>"));
	danvilleHTML = danvilleHTML.replace(new RegExp('Goings on About Town', 'g'), 'Goings On About Town');
	
	// Quick fix to make sure the style of li for short lists is "short-list"
	var rgxp = new RegExp('<paragraph>\r\t\t\t<!--goatcategory-->\r\t\t\t<bold>.*SHORT LIST', 'g');
    danvilleHTML.replace(rgxp, function(match, word) {
         return '</li>\n\n<li class="short-list">\r\t\t<a href="#" class="listings-toggle"></a>\r\t\t<header class="listings-toggle">\r\t\t\t<h2 class="ellipsis">'+match;
    });

	danvilleHTML = danvilleHTML.replace(new RegExp('<header>', 'g'), '<header class="listings-toggle">');
	danvilleHTML = danvilleHTML.replace(new RegExp('&#160;<span class="dingbat">&#9830;</span>', 'g'), '');

	danvilleHTML = danvilleHTML.replace(new RegExp("OF NOTE  ", 'g'), "<span class='red'>OF NOTE </span> ");
	danvilleHTML = danvilleHTML.replace(new RegExp("OF NOTE ", 'g'), "<span class='red'>OF NOTE </span> ");
	
	// Extra transformations for specific sections
	if (stackName.indexOf("movies") > 0) {
		danvilleHTML = danvilleHTML.replace(new RegExp('<header>', 'g'), '<header class="listings-toggle">');
	} else if (stackName.indexOf("dance") > 0 || stackName.indexOf("above") > 0) {
		danvilleHTML = danvilleHTML.replace(new RegExp('<li>', ''), '<li class="open">');
	} else if (stackName.indexOf("theatre") > 0) {
		danvilleHTML = danvilleHTML.replace(new RegExp('<h2 class="ellipsis">ALSO PLAYING</h2>', 'g'), '<h2 class="ellipsis">ALSO NOTABLE</h2>');
	}

	return danvilleHTML;
}

build.image.copy = function(file) {
	fs.exists(file.from, function(exists) { 
		if (exists) { 
			fs.exists(file.to,function (exists) {
				if(exists) { fs.createReadStream(file.from).pipe(fs.createWriteStream(file.to+file.filename)); }
				else { fs.mkdir(file.to,function(err,data){ fs.createReadStream(file.from).pipe(fs.createWriteStream(file.to+file.filename)); }); 00};
			});
		} else { console.log("File for "+file.filename+" "+file.type+" image does not exist.") }; 
	});
};

build.image.path = function(from,size,filename,date) {
	if (date) { var split=utils.format.date.split(date); from=paths.images.npp.replace("<!--year-->","20"+split.y).replace("<!--month-->",split.m).replace("<!--day-->",split.d); }
	return from+size+"/"+filename;
};

build.image.art = function(xml) {
	var date = utils.format.date.stack(xml.stackname), split = utils.format.date.split(date),
		from = paths.images.npp.replace("<!--year-->","20"+split.y).replace("<!--month-->",split.m).replace("<!--day-->",split.d),
		to = xml.output,
		trimmed = utils.format.stack.trim(xml.stackname);
	if (xml.image) {
		filename = date+"_"+xml.image,
		files = [
			{from:build.image.path(from,2560,filename+".jpg"), type:"full tablet", to:to+"HTMLResources/media/"+trimmed+"/", filename:date+"_"+xml.image+".jpg"},
			{from:build.image.path(from,640,filename+"_crop.jpg"), type:"mobile crop", to:to+"HTMLResources/media/"+trimmed+"/", filename:date+"_"+xml.image+"_crop.jpg"},
			{from:build.image.path(from,140,filename+"_cropth.png"), type:"thumbnail", to:to+xml.stackname+"/", filename:"toc.png"}
		];
	} else if (xml.stackname.indexOf("_poem_")>-1) {
		files = [ {from:paths.images.poem, type:"thumbnail", to:to+xml.stackname+"/", filename:"toc.png"} ];
	};
	for (var i=0; i<files.length; i++) {
		build.image.copy(files[i]);
	};
};

build.image.cartoon = function(date,toon,to) {
	var from = paths.images.npp.replace("<!--year-->","20"+date.slice(0,2)).replace("<!--month-->",date.slice(2,4)).replace("<!--day-->",date.slice(4,6)),
		filename = date+"_"+toon+".jpg",
		file = {from:build.image.path(from,2560,filename), type:"cartoon", to:to+"HTMLResources/media/cartoons/", filename:date+"_"+toon+".jpg"};
		build.image.copy(file);
};

build.image.generic = function(xml,image,to) {
	var date = utils.format.date.stack(xml.stackname), trimmed = utils.format.stack.trim(xml.stackname),
		from = paths.images.npp.replace("<!--year-->","20"+date.slice(0,2)).replace("<!--month-->",date.slice(2,4)).replace("<!--day-->",date.slice(4,6)),
		filename = image+".jpg",
		file = {from:build.image.path(from,2560,filename), type:"artwork", to:to+"HTMLResources/media/"+trimmed+"/", filename:image+".jpg"};
		build.image.copy(file);
};

build.image.spot = function(xml,spot,to) {
	var date = utils.format.date.stack(xml.stackname), trimmed = utils.format.stack.trim(xml.stackname),
		from = paths.images.npp.replace("<!--year-->","20"+date.slice(0,2)).replace("<!--month-->",date.slice(2,4)).replace("<!--day-->",date.slice(4,6)),
		filename = date+"_"+spot+".jpg",
		file = {from:build.image.path(from,2560,filename), type:"spot", to:to+"HTMLResources/media/"+trimmed+"/", filename:date+"_"+spot+".jpg"};
		build.image.copy(file);
};

module.exports = build;