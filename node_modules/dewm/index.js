var fs = require('fs');
var utils = require('dewm-utils');
var paths = require('dewm-paths');
var templates = require('dewm-templates');
var build = require('dewm-build');
var xml = require('xml2js');
var oplog = require('mongo-oplog');
var EventEmitter = require("events").EventEmitter;
var mongo = require('mongodb');
var dewm = {};

dewm.init = function() {
	var self = this;
	this.evt = new EventEmitter();
	this.evt.setMaxListeners(0);
	this.depts = ['makeup','makeup','copy','art'];
	this.getDates();
	this.monitorComments();
	this.monitorAssignments();
	utils.generateUserDict();
};

dewm.getDates = function() {
	var self = this;
	var dates = { "dates":[], "strings":[], "stringsWithHyphens":[], "stringsFormatted":[] };
	var mongoFound = [];
	var unordered = [];
	fs.readdir( paths.greenRoot, function (err, files) { 
	    if (!err) {
	        for (var i=0; i<files.length; i++) {
	        	if (files[i].match(/([0-9]){6}$/g) !== null && files[i] != "000000") {
	        		unordered.push(utils.format.date.object(files[i]));
	        	}
	        }
	    } else {
	        error = new Error("You're not connected to the Tablet Green server at the moment.")
	        throw error; 
	    };
	    ordered = unordered.sort(function(a,b){ return a-b; });
	    for (var i=0; i<ordered.length; i++) {
	    	d = utils.format.date.hyphen(ordered[i]);
	        dates.dates.push(d[0]);
	        dates.strings.push(d[1]);
	        dates.stringsWithHyphens.push(d[2]);
	        dates.stringsFormatted.push(d[3]);
	        mongoFound.push({ "string":d[1] });
	    };
	    self.checkMissingIssues(mongoFound,dates);
	    self.dates = dates;
	    self.weeks = [];
	    for (var i=0; i<dates.strings.length; i++) { 
		    self.weeks.push(templates.week(dates,i));
		};
		self.setWeek(dates.strings.length-3);
	});
};

dewm.setWeek = function(week,callback) {
	var self = this;
	self.latest = week;
	if (!self.weeks[week].init) {
		self.weeks[week].init = true;
		self.initWeek(week,callback);	
	} else {
		if(callback) {
			callback(response);
		};
	};
};

dewm.initWeek = function(week,callback) {
	var self = this,
		mode = typeof mode !== 'undefined' ? mode : "",
		issueDate = self.dates.strings[week],
		issueDateWithHyphens = self.dates.stringsWithHyphens[week],
		issueDateFormatted = self.dates.stringsFormatted[week];
	fs.exists(self.weeks[week].sidecar, function (exists) {
		if (!exists && self.weeks[week].sidecar.indexOf("Archive")>-1) {
			self.setWeek(week-1,callback)
		} else if (!exists) {
			var year = new Date(issueDateFormatted),
				year = year.getFullYear();
			self.weeks[week].sidecar = paths.sidecarArchive.replace(/<insert_year>/g,year).replace(/<insert_hyphen_date>/g,issueDateWithHyphens);
			self.weeks[week].orange = paths.orangeRootArchive.replace(/<insert_year>/g,year).replace(/<insert_hyphen_date>/g,issueDateWithHyphens);
			self.initWeek(week,callback);
		} else {
			self.monitorWeek(week);
			self.getWeek(week,callback);
		}
	});
	fs.exists(self.weeks[week].condenet, function (exists) {
		if (!exists) {
			var year = new Date(issueDateFormatted),
				year = year.getFullYear();
			self.weeks[week].condenet = paths.condenetArchive.replace(/<insert_year>/g,year).replace(/<insert_hyphen_date>/g,issueDateWithHyphens);
		};
	});
};

dewm.getWeek = function(week,callback) {
	var self = this;
	fs.readFile(self.weeks[week].sidecar, "utf8", function (err, data) {
		if (data===undefined) {
			self.setWeek(week-1);
		} else {
			xml.parseString(data, function (err, result) {
				if (result == undefined) {
					var response = "The Sidecar XML for "+issueDateFormatted+" is malformed and so it cannot be loaded. Please fix it and try again.";
					self.setWeek(week-1);
				} else {
					var response = "",
						stacks = self.formatStacks(result.sidecar.entry);
					self.weeks[week].files = stacks.files;
					self.weeks[week].stacks = stacks.stacks;
					//build.init(10,23,"danville",self)
				};
				if(callback) {
					callback(response);
				};
			});
		};
	});
};

dewm.monitorWeek = function(week) {
	var self = this;
	setInterval(function() {
		fs.stat(self.weeks[week].sidecar,function(err, stats){
			var modified = new Date(stats.mtime);
			if (self.weeks[week].modified<modified) {
				console.log("Update to the sidecar for "+dewm.dates.strings[week]);
				self.getWeek(week);
			};
		});
	},15000);
};

dewm.monitorComments = function(stack) {
	var	self = this,
		listener = oplog(paths.mongo.host+"local", 'dewm.comments').tail();
	listener.on('op', function (data) {
		utils.comments(function(items) {
			self.evt.emit("comment",items);
			if (data.op=="i") {
				utils.notifications.all("New comment added to the "+data.o.stack+" stack by "+dewm.users[data.o.username].name+": "+data.o.text,"http://dewm:3000/views/copy?stack="+data.o.stack)
			};
		});
	});
}

dewm.monitorAssignments = function(stack) {
	var	self = this,
		listener = oplog(paths.mongo.host+"local", 'dewm.assignments').tail();
	listener.on('update', function (data) {
		var id=new mongo.BSONPure.ObjectID(String(data.o2._id));
		utils.mongo.find("assignments",{_id:id},{},function(err, items){
			self.evt.emit("assignments",items[0].stack);
			//utils.notifications.all("Update to the assignments for "+items[0].stack+" by.","http://dewm:3000/views/makeup?stack="+data.o.stack)
		});
	});
}

dewm.checkMissingIssues = function(existing,dates) {
	var self = this,
		mongoDates = [],
		mongoToAdd = [];
	utils.mongo.find("issues",{$or:existing},{},function(err, items){
		for (var i=0; i<items.length; i++) {
			mongoDates.push(items[i]["string"]);
		}
		for (var i=0; i<dates.strings.length; i++) {
			if (mongoDates.indexOf(dates.strings[i])<0) {
				mongoToAdd.push(templates.issue(dates,i));
			}
		}
		utils.mongo.upsert("issues",mongoToAdd);
	})
}

dewm.formatStacks = function(stacks) {
	var self = this,
		returnStacks = [],
		stackNumbers = [],
		assignments = [],
		issue = utils.format.date.stack(stacks[0].folderName[0]);
	for (var i=0; i<stacks.length; i++) {
		var title = stacks[i].articleTitle[0],
			stackDate = utils.format.date.stack(stacks[i].folderName[0]),
			doc = templates.stack(title,stacks,stackDate,i),
			assignment = templates.assignment(stacks[i].folderName[0]);
		if (stackDate != "undefined" ) {
			stackNumbers.push(stacks[i].folderName[0]);
			returnStacks.push(doc);
			assignments.push(assignment);
		}
	}
	utils.mongo.find("stacks",{issue:issue},{stack:1,_id:0},function(err,original){
		for (var i=0; i<original.length; i++) {
			original[i]=original[i].stack;
		}
		var added=utils.diff(original,stackNumbers)
			deleted=utils.diff(stackNumbers,original);
		if (added.length>0 && deleted.length>0) {
			self.evt.emit("stack",[added,deleted]);
			self.weeks[self.dates.strings.indexOf(issue)].modified = -1;
		} else {
			self.weeks[self.dates.strings.indexOf(issue)].modified = new Date();
			utils.mongo.upsert("stacks",returnStacks,"stack","stack")
			utils.mongo.insert("assignments",assignments,stackNumbers)
			utils.mongo.remove("stacks",{stack: { $in: deleted } });
		}
	});
	return {stacks:returnStacks,files:stackNumbers};
}

dewm.initSocket = function (server,session) {
	var self = this,
		io = require('socket.io')(server);
	io.use(require("express-socket.io-session")(session));
    io.on('connection', function (socket) {
    	var newStack = function(stacks){
    		socket.emit('newStack', stacks);
    	};
    	var newAssignment = function(stack){
    		socket.emit('assignments', stack);
    	};
    	self.evt.on("stack",newStack);
    	self.evt.on("assignments",newAssignment);
    	socket.on('disconnect',function() {
    		self.evt.removeListener("stack",newStack);
    		self.evt.removeListener('assignments', newAssignment);
    		if (socket.handshake.session.username) {
    			var stack=socket.handshake.headers.referer.split("stack=")[1];
    			if (stack) { utils.checkReader(stack,socket.handshake.session.username,false); }
    		};
    	});
    	socket.on('reqStack', function (data) {
    		utils.mongo.check(data[0]);
    		self.weeks[data[1]].modified = new Date();
    		socket.emit('endStack');
    	});
        socket.on('reqComment', function (data) {
        	utils.comments(function(comments){
	    		socket.emit('newComment',comments);
	    	},data.stack,data.dept);
            self.evt.on("comment",function(comments){
	            var returnComments = utils.commentsFilter(comments,data.stack,data.dept)
	            socket.emit('newComment', returnComments);
            });
        });
		socket.on('reading', function (data) {
			utils.checkReader(data.stack,data.username,true);
		});
    });	
}

dewm.init();

module.exports = dewm;