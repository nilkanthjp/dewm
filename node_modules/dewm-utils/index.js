// Database
var mongo = require('mongoskin');
var db = mongo.db("mongodb://dewm:27017/dewm", {native_parser:true, safe:true});

var utils = {};

utils.pad = function(n, width, z) {
	z = z || '0';
	n = n + '';
	return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

utils.formatDate = function(dateToFormat) {
	d = Array(5);
	d[0] = dateToFormat;
	var year = utils.pad(d[0].getFullYear(),2).substring(2);
	var month = utils.pad(d[0].getMonth()+1,2);
	var date = utils.pad(d[0].getDate(),2);
	d[1] = year+month+date;
	d[2] = year+"-"+month+"-"+date;
	d[3] = utils.months[d[0].getMonth()]+" "+d[0].getDate()+", "+d[0].getFullYear();
	return(d);
}

utils.createDateObject = function(dateToParse) {
	if (dateToParse.indexOf("-")>0) { dateToParse = dateToParse.split("-"); } 
	else { dateToParse = dateToParse.split(/(?=(?:..)*$)/); }
	return(new Date("20"+dateToParse[0],parseInt(dateToParse[1])-1,dateToParse[2]) );
}

utils.checkMissingIssues = function(existing,dates) {
	var mongoDates = [];
	var mongoToAdd = []
	db.collection('issues').find( { $or: existing }, { "_id":false } ).toArray(function (err, items) {
		for (var i=0; i<items.length; i++) {
			mongoDates.push(items[i]["string"]);
		}
		for (var i=0; i<dates.strings.length; i++) {
			if (mongoDates.indexOf(dates.strings[i])<0) {
				mongoToAdd.push( { 
					"date":dates.dates[i], 
					"string":dates.strings[i], 
					"hyphen":dates.stringsWithHyphens[i], 
					"formatted":dates.stringsFormatted[i]
				} )
			}
		}
		utils.addIssues(mongoToAdd);
	});
}

utils.addStacks = function(stacks) {
	var returnStacks = [],
		stackNumbers = [];
	for (var i=0; i<stacks.length; i++) {
		var title = stacks[i].articleTitle[0],
			modified = new Date();
		if (stacks[i].folderName[0].split("_")[3] !== null)  {
			stackDate = stacks[i].folderName[0].split("_")[3];
		} else {
			stackDate = stacks[i].folderName[0].split("_")[2];
		}
		var doc = { 
			"title":title.split(" by ")[0].replace("”","").replace("“",""), 
			"stack":stacks[i].folderName[0], 
			"issue":stackDate, 
			"author":title.split(" by ")[1], 
			"kicker":stacks[i].kicker[0], 
			"description":stacks[i].description[0],
			"layout":null,
			"reading":{},
			"copyAssignment":{},
			"artAssignment":{},
			"danville":null,
			"tablet":null
		};
		stackNumbers.push(stacks[i].folderName[0]);
		returnStacks.push(doc);
	}
	db.collection('stacks',function(err,collection) {
		var bulk = collection.initializeUnorderedBulkOp();
		for (var i = 0; i < returnStacks.length; i++) {
			bulk.find({stack:returnStacks[i].stack}).upsert().update({ $set: returnStacks[i] });
		}
		bulk.execute(function(err,result) {
			if (err) { console.log(err) } 
			else { console.log("Sucessfully inserted "+result.nInserted+" stacks for the "+stackDate+" issue.") } 
		});    
    });
	return returnStacks;
}

utils.addIssues = function(toAdd) {
	if (toAdd.length>0) {
		db.collection('issues').insert( toAdd, function(err, result) {
			if (err) { console.log(err) };
			if (result) { console.log('Added issue(s).'); };
		});		
	}
}

utils.getStack = function(stack) {
	//db.collection('stacks').find( { $or: existing }, { "_id":false } ).toArray(function (err, items) {
}

utils.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

module.exports = utils;